"use strict";
var ɵngcc0 = require('@angular/core');
var ɵngcc1 = require('./svg-cache.service');
var ɵngcc2 = require('./inline-svg.service');
var ɵngcc3 = require('./inline-svg.config');
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var common_1 = require("@angular/common");
var inline_svg_component_1 = require("./inline-svg.component");
var svg_cache_service_1 = require("./svg-cache.service");
var inline_svg_service_1 = require("./inline-svg.service");
var inline_svg_config_1 = require("./inline-svg.config");
var SvgUtil = require("./svg-util");
var InlineSVGDirective = (function () {
    function InlineSVGDirective(_el, _viewContainerRef, _resolver, _svgCache, _renderer, _inlineSVGService, _config, platformId) {
        this._el = _el;
        this._viewContainerRef = _viewContainerRef;
        this._resolver = _resolver;
        this._svgCache = _svgCache;
        this._renderer = _renderer;
        this._inlineSVGService = _inlineSVGService;
        this._config = _config;
        this.platformId = platformId;
        this.resolveSVGUrl = true;
        this.replaceContents = true;
        this.prepend = false;
        this.injectComponent = false;
        this.cacheSVG = true;
        this.forceEvalStyles = false;
        this.evalScripts = "always";
        this.onSVGInserted = new core_1.EventEmitter();
        this.onSVGFailed = new core_1.EventEmitter();
        this._supportsSVG = SvgUtil.isSvgSupported();
        if (!common_1.isPlatformServer(this.platformId) && !this._supportsSVG) {
            this._fail('Embed SVG are not supported by this browser');
        }
    }
    InlineSVGDirective.prototype.ngOnInit = function () {
        if (!this._isValidPlatform() || this._isSSRDisabled()) {
            return;
        }
        this._insertSVG();
    };
    InlineSVGDirective.prototype.ngOnChanges = function (changes) {
        if (!this._isValidPlatform() || this._isSSRDisabled()) {
            return;
        }
        if (changes['inlineSVG'] || changes['setSVGAttributes']) {
            this._insertSVG();
        }
    };
    InlineSVGDirective.prototype.ngOnDestroy = function () {
        if (this._subscription) {
            this._subscription.unsubscribe();
        }
    };
    InlineSVGDirective.prototype._insertSVG = function () {
        var _this = this;
        if (!common_1.isPlatformServer(this.platformId) && !this._supportsSVG) {
            return;
        }
        if (!this.inlineSVG) {
            this._fail('No URL passed to [inlineSVG]');
            return;
        }
        if (this.inlineSVG === this._prevUrl) {
            return;
        }
        this._prevUrl = this.inlineSVG;
        this._subscription = this._svgCache.getSVG(this.inlineSVG, this.resolveSVGUrl, this.cacheSVG)
            .subscribe(function (svg) {
            if (SvgUtil.isUrlSymbol(_this.inlineSVG)) {
                var symbolId = _this.inlineSVG.split('#')[1];
                svg = SvgUtil.createSymbolSvg(_this._renderer, svg, symbolId);
            }
            _this._processSvg(svg);
        }, function (err) {
            _this._fail(err);
        });
    };
    InlineSVGDirective.prototype._processSvg = function (svg) {
        if (!svg) {
            return;
        }
        if (this.removeSVGAttributes && common_1.isPlatformBrowser(this.platformId)) {
            SvgUtil.removeAttributes(svg, this.removeSVGAttributes);
        }
        if (this.setSVGAttributes) {
            SvgUtil.setAttributes(svg, this.setSVGAttributes);
        }
        if (this.onSVGLoaded) {
            svg = this.onSVGLoaded(svg, this._el.nativeElement);
        }
        this._insertEl(svg);
        if (common_1.isPlatformBrowser(this.platformId)) {
            this._inlineSVGService.evalScripts(svg, this.inlineSVG, this.evalScripts);
        }
        if (this.forceEvalStyles) {
            var styleTags = svg.querySelectorAll('style');
            Array.from(styleTags).forEach(function (tag) { return tag.textContent += ''; });
        }
        this.onSVGInserted.emit(svg);
    };
    InlineSVGDirective.prototype._insertEl = function (el) {
        if (this.injectComponent) {
            if (!this._svgComp) {
                var factory = this._resolver.resolveComponentFactory(inline_svg_component_1.InlineSVGComponent);
                this._svgComp = this._viewContainerRef.createComponent(factory);
            }
            this._svgComp.instance.context = this;
            this._svgComp.instance.replaceContents = this.replaceContents;
            this._svgComp.instance.prepend = this.prepend;
            this._svgComp.instance.content = el;
            this._renderer.appendChild(this._el.nativeElement, this._svgComp.injector.get(inline_svg_component_1.InlineSVGComponent)._el.nativeElement);
        }
        else {
            this._inlineSVGService.insertEl(this, this._el.nativeElement, el, this.replaceContents, this.prepend);
        }
    };
    InlineSVGDirective.prototype._fail = function (msg) {
        this.onSVGFailed.emit(msg);
        if (this.fallbackImgUrl) {
            var elImg = this._renderer.createElement('IMG');
            this._renderer.setAttribute(elImg, 'src', this.fallbackImgUrl);
            this._insertEl(elImg);
        }
    };
    InlineSVGDirective.prototype._isValidPlatform = function () {
        return common_1.isPlatformServer(this.platformId) || common_1.isPlatformBrowser(this.platformId);
    };
    InlineSVGDirective.prototype._isSSRDisabled = function () {
        return common_1.isPlatformServer(this.platformId) && this._config && this._config.clientOnly;
    };
    __decorate([
        core_1.Input(),
        __metadata("design:type", String)
    ], InlineSVGDirective.prototype, "inlineSVG", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", Boolean)
    ], InlineSVGDirective.prototype, "resolveSVGUrl", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", Boolean)
    ], InlineSVGDirective.prototype, "replaceContents", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", Boolean)
    ], InlineSVGDirective.prototype, "prepend", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", Boolean)
    ], InlineSVGDirective.prototype, "injectComponent", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", Boolean)
    ], InlineSVGDirective.prototype, "cacheSVG", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", Object)
    ], InlineSVGDirective.prototype, "setSVGAttributes", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", Array)
    ], InlineSVGDirective.prototype, "removeSVGAttributes", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", Boolean)
    ], InlineSVGDirective.prototype, "forceEvalStyles", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", String)
    ], InlineSVGDirective.prototype, "evalScripts", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", String)
    ], InlineSVGDirective.prototype, "fallbackImgUrl", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", Function)
    ], InlineSVGDirective.prototype, "onSVGLoaded", void 0);
    __decorate([
        core_1.Output(),
        __metadata("design:type", core_1.EventEmitter)
    ], InlineSVGDirective.prototype, "onSVGInserted", void 0);
    __decorate([
        core_1.Output(),
        __metadata("design:type", core_1.EventEmitter)
    ], InlineSVGDirective.prototype, "onSVGFailed", void 0);
    InlineSVGDirective = __decorate([ __param(6, core_1.Optional()),
        __param(7, core_1.Inject(core_1.PLATFORM_ID)),
        __metadata("design:paramtypes", [core_1.ElementRef,
            core_1.ViewContainerRef,
            core_1.ComponentFactoryResolver,
            svg_cache_service_1.SVGCacheService,
            core_1.Renderer2,
            inline_svg_service_1.InlineSVGService,
            inline_svg_config_1.InlineSVGConfig,
            Object])
    ], InlineSVGDirective);
InlineSVGDirective.ɵfac = function InlineSVGDirective_Factory(t) { return new (t || InlineSVGDirective)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ViewContainerRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ComponentFactoryResolver), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.SVGCacheService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.Renderer2), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.InlineSVGService), ɵngcc0.ɵɵdirectiveInject(ɵngcc3.InlineSVGConfig, 8), ɵngcc0.ɵɵdirectiveInject(core_1.PLATFORM_ID)); };
InlineSVGDirective.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: InlineSVGDirective, selectors: [["", "inlineSVG", ""]], inputs: { resolveSVGUrl: "resolveSVGUrl", replaceContents: "replaceContents", prepend: "prepend", injectComponent: "injectComponent", cacheSVG: "cacheSVG", forceEvalStyles: "forceEvalStyles", evalScripts: "evalScripts", inlineSVG: "inlineSVG", setSVGAttributes: "setSVGAttributes", removeSVGAttributes: "removeSVGAttributes", fallbackImgUrl: "fallbackImgUrl", onSVGLoaded: "onSVGLoaded" }, outputs: { onSVGInserted: "onSVGInserted", onSVGFailed: "onSVGFailed" }, features: [ɵngcc0.ɵɵProvidersFeature([svg_cache_service_1.SVGCacheService]), ɵngcc0.ɵɵNgOnChangesFeature] });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(InlineSVGDirective, [{
        type: core_1.Directive,
        args: [{
                selector: '[inlineSVG]',
                providers: [svg_cache_service_1.SVGCacheService]
            }]
    }], function () { return [{ type: ɵngcc0.ElementRef }, { type: ɵngcc0.ViewContainerRef }, { type: ɵngcc0.ComponentFactoryResolver }, { type: ɵngcc1.SVGCacheService }, { type: ɵngcc0.Renderer2 }, { type: ɵngcc2.InlineSVGService }, { type: ɵngcc3.InlineSVGConfig, decorators: [{
                type: core_1.Optional
            }] }, { type: Object, decorators: [{
                type: core_1.Inject,
                args: [core_1.PLATFORM_ID]
            }] }]; }, { resolveSVGUrl: [{
            type: core_1.Input
        }], replaceContents: [{
            type: core_1.Input
        }], prepend: [{
            type: core_1.Input
        }], injectComponent: [{
            type: core_1.Input
        }], cacheSVG: [{
            type: core_1.Input
        }], forceEvalStyles: [{
            type: core_1.Input
        }], evalScripts: [{
            type: core_1.Input
        }], onSVGInserted: [{
            type: core_1.Output
        }], onSVGFailed: [{
            type: core_1.Output
        }], inlineSVG: [{
            type: core_1.Input
        }], setSVGAttributes: [{
            type: core_1.Input
        }], removeSVGAttributes: [{
            type: core_1.Input
        }], fallbackImgUrl: [{
            type: core_1.Input
        }], onSVGLoaded: [{
            type: core_1.Input
        }] }); })();
    return InlineSVGDirective;
}());
exports.InlineSVGDirective = InlineSVGDirective;

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5saW5lLXN2Zy5kaXJlY3RpdmUuanMiLCJzb3VyY2VzIjpbImlubGluZS1zdmcuZGlyZWN0aXZlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7OztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUNBS087QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O29CQUEyQjtBQUMzQjtBQUNBO0FBQ0EiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xufTtcbnZhciBfX21ldGFkYXRhID0gKHRoaXMgJiYgdGhpcy5fX21ldGFkYXRhKSB8fCBmdW5jdGlvbiAoaywgdikge1xuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5tZXRhZGF0YSA9PT0gXCJmdW5jdGlvblwiKSByZXR1cm4gUmVmbGVjdC5tZXRhZGF0YShrLCB2KTtcbn07XG52YXIgX19wYXJhbSA9ICh0aGlzICYmIHRoaXMuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xuICAgIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsgZGVjb3JhdG9yKHRhcmdldCwga2V5LCBwYXJhbUluZGV4KTsgfVxufTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbnZhciBjb3JlXzEgPSByZXF1aXJlKFwiQGFuZ3VsYXIvY29yZVwiKTtcbnZhciBjb21tb25fMSA9IHJlcXVpcmUoXCJAYW5ndWxhci9jb21tb25cIik7XG52YXIgaW5saW5lX3N2Z19jb21wb25lbnRfMSA9IHJlcXVpcmUoXCIuL2lubGluZS1zdmcuY29tcG9uZW50XCIpO1xudmFyIHN2Z19jYWNoZV9zZXJ2aWNlXzEgPSByZXF1aXJlKFwiLi9zdmctY2FjaGUuc2VydmljZVwiKTtcbnZhciBpbmxpbmVfc3ZnX3NlcnZpY2VfMSA9IHJlcXVpcmUoXCIuL2lubGluZS1zdmcuc2VydmljZVwiKTtcbnZhciBpbmxpbmVfc3ZnX2NvbmZpZ18xID0gcmVxdWlyZShcIi4vaW5saW5lLXN2Zy5jb25maWdcIik7XG52YXIgU3ZnVXRpbCA9IHJlcXVpcmUoXCIuL3N2Zy11dGlsXCIpO1xudmFyIElubGluZVNWR0RpcmVjdGl2ZSA9IChmdW5jdGlvbiAoKSB7XG4gICAgZnVuY3Rpb24gSW5saW5lU1ZHRGlyZWN0aXZlKF9lbCwgX3ZpZXdDb250YWluZXJSZWYsIF9yZXNvbHZlciwgX3N2Z0NhY2hlLCBfcmVuZGVyZXIsIF9pbmxpbmVTVkdTZXJ2aWNlLCBfY29uZmlnLCBwbGF0Zm9ybUlkKSB7XG4gICAgICAgIHRoaXMuX2VsID0gX2VsO1xuICAgICAgICB0aGlzLl92aWV3Q29udGFpbmVyUmVmID0gX3ZpZXdDb250YWluZXJSZWY7XG4gICAgICAgIHRoaXMuX3Jlc29sdmVyID0gX3Jlc29sdmVyO1xuICAgICAgICB0aGlzLl9zdmdDYWNoZSA9IF9zdmdDYWNoZTtcbiAgICAgICAgdGhpcy5fcmVuZGVyZXIgPSBfcmVuZGVyZXI7XG4gICAgICAgIHRoaXMuX2lubGluZVNWR1NlcnZpY2UgPSBfaW5saW5lU1ZHU2VydmljZTtcbiAgICAgICAgdGhpcy5fY29uZmlnID0gX2NvbmZpZztcbiAgICAgICAgdGhpcy5wbGF0Zm9ybUlkID0gcGxhdGZvcm1JZDtcbiAgICAgICAgdGhpcy5yZXNvbHZlU1ZHVXJsID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5yZXBsYWNlQ29udGVudHMgPSB0cnVlO1xuICAgICAgICB0aGlzLnByZXBlbmQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5pbmplY3RDb21wb25lbnQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5jYWNoZVNWRyA9IHRydWU7XG4gICAgICAgIHRoaXMuZm9yY2VFdmFsU3R5bGVzID0gZmFsc2U7XG4gICAgICAgIHRoaXMuZXZhbFNjcmlwdHMgPSBcImFsd2F5c1wiO1xuICAgICAgICB0aGlzLm9uU1ZHSW5zZXJ0ZWQgPSBuZXcgY29yZV8xLkV2ZW50RW1pdHRlcigpO1xuICAgICAgICB0aGlzLm9uU1ZHRmFpbGVkID0gbmV3IGNvcmVfMS5FdmVudEVtaXR0ZXIoKTtcbiAgICAgICAgdGhpcy5fc3VwcG9ydHNTVkcgPSBTdmdVdGlsLmlzU3ZnU3VwcG9ydGVkKCk7XG4gICAgICAgIGlmICghY29tbW9uXzEuaXNQbGF0Zm9ybVNlcnZlcih0aGlzLnBsYXRmb3JtSWQpICYmICF0aGlzLl9zdXBwb3J0c1NWRykge1xuICAgICAgICAgICAgdGhpcy5fZmFpbCgnRW1iZWQgU1ZHIGFyZSBub3Qgc3VwcG9ydGVkIGJ5IHRoaXMgYnJvd3NlcicpO1xuICAgICAgICB9XG4gICAgfVxuICAgIElubGluZVNWR0RpcmVjdGl2ZS5wcm90b3R5cGUubmdPbkluaXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmICghdGhpcy5faXNWYWxpZFBsYXRmb3JtKCkgfHwgdGhpcy5faXNTU1JEaXNhYmxlZCgpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5faW5zZXJ0U1ZHKCk7XG4gICAgfTtcbiAgICBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLm5nT25DaGFuZ2VzID0gZnVuY3Rpb24gKGNoYW5nZXMpIHtcbiAgICAgICAgaWYgKCF0aGlzLl9pc1ZhbGlkUGxhdGZvcm0oKSB8fCB0aGlzLl9pc1NTUkRpc2FibGVkKCkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY2hhbmdlc1snaW5saW5lU1ZHJ10gfHwgY2hhbmdlc1snc2V0U1ZHQXR0cmlidXRlcyddKSB7XG4gICAgICAgICAgICB0aGlzLl9pbnNlcnRTVkcoKTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgSW5saW5lU1ZHRGlyZWN0aXZlLnByb3RvdHlwZS5uZ09uRGVzdHJveSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKHRoaXMuX3N1YnNjcmlwdGlvbikge1xuICAgICAgICAgICAgdGhpcy5fc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIElubGluZVNWR0RpcmVjdGl2ZS5wcm90b3R5cGUuX2luc2VydFNWRyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAgICAgaWYgKCFjb21tb25fMS5pc1BsYXRmb3JtU2VydmVyKHRoaXMucGxhdGZvcm1JZCkgJiYgIXRoaXMuX3N1cHBvcnRzU1ZHKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLmlubGluZVNWRykge1xuICAgICAgICAgICAgdGhpcy5fZmFpbCgnTm8gVVJMIHBhc3NlZCB0byBbaW5saW5lU1ZHXScpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmlubGluZVNWRyA9PT0gdGhpcy5fcHJldlVybCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3ByZXZVcmwgPSB0aGlzLmlubGluZVNWRztcbiAgICAgICAgdGhpcy5fc3Vic2NyaXB0aW9uID0gdGhpcy5fc3ZnQ2FjaGUuZ2V0U1ZHKHRoaXMuaW5saW5lU1ZHLCB0aGlzLnJlc29sdmVTVkdVcmwsIHRoaXMuY2FjaGVTVkcpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKGZ1bmN0aW9uIChzdmcpIHtcbiAgICAgICAgICAgIGlmIChTdmdVdGlsLmlzVXJsU3ltYm9sKF90aGlzLmlubGluZVNWRykpIHtcbiAgICAgICAgICAgICAgICB2YXIgc3ltYm9sSWQgPSBfdGhpcy5pbmxpbmVTVkcuc3BsaXQoJyMnKVsxXTtcbiAgICAgICAgICAgICAgICBzdmcgPSBTdmdVdGlsLmNyZWF0ZVN5bWJvbFN2ZyhfdGhpcy5fcmVuZGVyZXIsIHN2Zywgc3ltYm9sSWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgX3RoaXMuX3Byb2Nlc3NTdmcoc3ZnKTtcbiAgICAgICAgfSwgZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgX3RoaXMuX2ZhaWwoZXJyKTtcbiAgICAgICAgfSk7XG4gICAgfTtcbiAgICBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLl9wcm9jZXNzU3ZnID0gZnVuY3Rpb24gKHN2Zykge1xuICAgICAgICBpZiAoIXN2Zykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnJlbW92ZVNWR0F0dHJpYnV0ZXMgJiYgY29tbW9uXzEuaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSkge1xuICAgICAgICAgICAgU3ZnVXRpbC5yZW1vdmVBdHRyaWJ1dGVzKHN2ZywgdGhpcy5yZW1vdmVTVkdBdHRyaWJ1dGVzKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5zZXRTVkdBdHRyaWJ1dGVzKSB7XG4gICAgICAgICAgICBTdmdVdGlsLnNldEF0dHJpYnV0ZXMoc3ZnLCB0aGlzLnNldFNWR0F0dHJpYnV0ZXMpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLm9uU1ZHTG9hZGVkKSB7XG4gICAgICAgICAgICBzdmcgPSB0aGlzLm9uU1ZHTG9hZGVkKHN2ZywgdGhpcy5fZWwubmF0aXZlRWxlbWVudCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5faW5zZXJ0RWwoc3ZnKTtcbiAgICAgICAgaWYgKGNvbW1vbl8xLmlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkpIHtcbiAgICAgICAgICAgIHRoaXMuX2lubGluZVNWR1NlcnZpY2UuZXZhbFNjcmlwdHMoc3ZnLCB0aGlzLmlubGluZVNWRywgdGhpcy5ldmFsU2NyaXB0cyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuZm9yY2VFdmFsU3R5bGVzKSB7XG4gICAgICAgICAgICB2YXIgc3R5bGVUYWdzID0gc3ZnLnF1ZXJ5U2VsZWN0b3JBbGwoJ3N0eWxlJyk7XG4gICAgICAgICAgICBBcnJheS5mcm9tKHN0eWxlVGFncykuZm9yRWFjaChmdW5jdGlvbiAodGFnKSB7IHJldHVybiB0YWcudGV4dENvbnRlbnQgKz0gJyc7IH0pO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMub25TVkdJbnNlcnRlZC5lbWl0KHN2Zyk7XG4gICAgfTtcbiAgICBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLl9pbnNlcnRFbCA9IGZ1bmN0aW9uIChlbCkge1xuICAgICAgICBpZiAodGhpcy5pbmplY3RDb21wb25lbnQpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5fc3ZnQ29tcCkge1xuICAgICAgICAgICAgICAgIHZhciBmYWN0b3J5ID0gdGhpcy5fcmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoaW5saW5lX3N2Z19jb21wb25lbnRfMS5JbmxpbmVTVkdDb21wb25lbnQpO1xuICAgICAgICAgICAgICAgIHRoaXMuX3N2Z0NvbXAgPSB0aGlzLl92aWV3Q29udGFpbmVyUmVmLmNyZWF0ZUNvbXBvbmVudChmYWN0b3J5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuX3N2Z0NvbXAuaW5zdGFuY2UuY29udGV4dCA9IHRoaXM7XG4gICAgICAgICAgICB0aGlzLl9zdmdDb21wLmluc3RhbmNlLnJlcGxhY2VDb250ZW50cyA9IHRoaXMucmVwbGFjZUNvbnRlbnRzO1xuICAgICAgICAgICAgdGhpcy5fc3ZnQ29tcC5pbnN0YW5jZS5wcmVwZW5kID0gdGhpcy5wcmVwZW5kO1xuICAgICAgICAgICAgdGhpcy5fc3ZnQ29tcC5pbnN0YW5jZS5jb250ZW50ID0gZWw7XG4gICAgICAgICAgICB0aGlzLl9yZW5kZXJlci5hcHBlbmRDaGlsZCh0aGlzLl9lbC5uYXRpdmVFbGVtZW50LCB0aGlzLl9zdmdDb21wLmluamVjdG9yLmdldChpbmxpbmVfc3ZnX2NvbXBvbmVudF8xLklubGluZVNWR0NvbXBvbmVudCkuX2VsLm5hdGl2ZUVsZW1lbnQpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5faW5saW5lU1ZHU2VydmljZS5pbnNlcnRFbCh0aGlzLCB0aGlzLl9lbC5uYXRpdmVFbGVtZW50LCBlbCwgdGhpcy5yZXBsYWNlQ29udGVudHMsIHRoaXMucHJlcGVuZCk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIElubGluZVNWR0RpcmVjdGl2ZS5wcm90b3R5cGUuX2ZhaWwgPSBmdW5jdGlvbiAobXNnKSB7XG4gICAgICAgIHRoaXMub25TVkdGYWlsZWQuZW1pdChtc2cpO1xuICAgICAgICBpZiAodGhpcy5mYWxsYmFja0ltZ1VybCkge1xuICAgICAgICAgICAgdmFyIGVsSW1nID0gdGhpcy5fcmVuZGVyZXIuY3JlYXRlRWxlbWVudCgnSU1HJyk7XG4gICAgICAgICAgICB0aGlzLl9yZW5kZXJlci5zZXRBdHRyaWJ1dGUoZWxJbWcsICdzcmMnLCB0aGlzLmZhbGxiYWNrSW1nVXJsKTtcbiAgICAgICAgICAgIHRoaXMuX2luc2VydEVsKGVsSW1nKTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgSW5saW5lU1ZHRGlyZWN0aXZlLnByb3RvdHlwZS5faXNWYWxpZFBsYXRmb3JtID0gZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gY29tbW9uXzEuaXNQbGF0Zm9ybVNlcnZlcih0aGlzLnBsYXRmb3JtSWQpIHx8IGNvbW1vbl8xLmlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCk7XG4gICAgfTtcbiAgICBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLl9pc1NTUkRpc2FibGVkID0gZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gY29tbW9uXzEuaXNQbGF0Zm9ybVNlcnZlcih0aGlzLnBsYXRmb3JtSWQpICYmIHRoaXMuX2NvbmZpZyAmJiB0aGlzLl9jb25maWcuY2xpZW50T25seTtcbiAgICB9O1xuICAgIF9fZGVjb3JhdGUoW1xuICAgICAgICBjb3JlXzEuSW5wdXQoKSxcbiAgICAgICAgX19tZXRhZGF0YShcImRlc2lnbjp0eXBlXCIsIFN0cmluZylcbiAgICBdLCBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLCBcImlubGluZVNWR1wiLCB2b2lkIDApO1xuICAgIF9fZGVjb3JhdGUoW1xuICAgICAgICBjb3JlXzEuSW5wdXQoKSxcbiAgICAgICAgX19tZXRhZGF0YShcImRlc2lnbjp0eXBlXCIsIEJvb2xlYW4pXG4gICAgXSwgSW5saW5lU1ZHRGlyZWN0aXZlLnByb3RvdHlwZSwgXCJyZXNvbHZlU1ZHVXJsXCIsIHZvaWQgMCk7XG4gICAgX19kZWNvcmF0ZShbXG4gICAgICAgIGNvcmVfMS5JbnB1dCgpLFxuICAgICAgICBfX21ldGFkYXRhKFwiZGVzaWduOnR5cGVcIiwgQm9vbGVhbilcbiAgICBdLCBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLCBcInJlcGxhY2VDb250ZW50c1wiLCB2b2lkIDApO1xuICAgIF9fZGVjb3JhdGUoW1xuICAgICAgICBjb3JlXzEuSW5wdXQoKSxcbiAgICAgICAgX19tZXRhZGF0YShcImRlc2lnbjp0eXBlXCIsIEJvb2xlYW4pXG4gICAgXSwgSW5saW5lU1ZHRGlyZWN0aXZlLnByb3RvdHlwZSwgXCJwcmVwZW5kXCIsIHZvaWQgMCk7XG4gICAgX19kZWNvcmF0ZShbXG4gICAgICAgIGNvcmVfMS5JbnB1dCgpLFxuICAgICAgICBfX21ldGFkYXRhKFwiZGVzaWduOnR5cGVcIiwgQm9vbGVhbilcbiAgICBdLCBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLCBcImluamVjdENvbXBvbmVudFwiLCB2b2lkIDApO1xuICAgIF9fZGVjb3JhdGUoW1xuICAgICAgICBjb3JlXzEuSW5wdXQoKSxcbiAgICAgICAgX19tZXRhZGF0YShcImRlc2lnbjp0eXBlXCIsIEJvb2xlYW4pXG4gICAgXSwgSW5saW5lU1ZHRGlyZWN0aXZlLnByb3RvdHlwZSwgXCJjYWNoZVNWR1wiLCB2b2lkIDApO1xuICAgIF9fZGVjb3JhdGUoW1xuICAgICAgICBjb3JlXzEuSW5wdXQoKSxcbiAgICAgICAgX19tZXRhZGF0YShcImRlc2lnbjp0eXBlXCIsIE9iamVjdClcbiAgICBdLCBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLCBcInNldFNWR0F0dHJpYnV0ZXNcIiwgdm9pZCAwKTtcbiAgICBfX2RlY29yYXRlKFtcbiAgICAgICAgY29yZV8xLklucHV0KCksXG4gICAgICAgIF9fbWV0YWRhdGEoXCJkZXNpZ246dHlwZVwiLCBBcnJheSlcbiAgICBdLCBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLCBcInJlbW92ZVNWR0F0dHJpYnV0ZXNcIiwgdm9pZCAwKTtcbiAgICBfX2RlY29yYXRlKFtcbiAgICAgICAgY29yZV8xLklucHV0KCksXG4gICAgICAgIF9fbWV0YWRhdGEoXCJkZXNpZ246dHlwZVwiLCBCb29sZWFuKVxuICAgIF0sIElubGluZVNWR0RpcmVjdGl2ZS5wcm90b3R5cGUsIFwiZm9yY2VFdmFsU3R5bGVzXCIsIHZvaWQgMCk7XG4gICAgX19kZWNvcmF0ZShbXG4gICAgICAgIGNvcmVfMS5JbnB1dCgpLFxuICAgICAgICBfX21ldGFkYXRhKFwiZGVzaWduOnR5cGVcIiwgU3RyaW5nKVxuICAgIF0sIElubGluZVNWR0RpcmVjdGl2ZS5wcm90b3R5cGUsIFwiZXZhbFNjcmlwdHNcIiwgdm9pZCAwKTtcbiAgICBfX2RlY29yYXRlKFtcbiAgICAgICAgY29yZV8xLklucHV0KCksXG4gICAgICAgIF9fbWV0YWRhdGEoXCJkZXNpZ246dHlwZVwiLCBTdHJpbmcpXG4gICAgXSwgSW5saW5lU1ZHRGlyZWN0aXZlLnByb3RvdHlwZSwgXCJmYWxsYmFja0ltZ1VybFwiLCB2b2lkIDApO1xuICAgIF9fZGVjb3JhdGUoW1xuICAgICAgICBjb3JlXzEuSW5wdXQoKSxcbiAgICAgICAgX19tZXRhZGF0YShcImRlc2lnbjp0eXBlXCIsIEZ1bmN0aW9uKVxuICAgIF0sIElubGluZVNWR0RpcmVjdGl2ZS5wcm90b3R5cGUsIFwib25TVkdMb2FkZWRcIiwgdm9pZCAwKTtcbiAgICBfX2RlY29yYXRlKFtcbiAgICAgICAgY29yZV8xLk91dHB1dCgpLFxuICAgICAgICBfX21ldGFkYXRhKFwiZGVzaWduOnR5cGVcIiwgY29yZV8xLkV2ZW50RW1pdHRlcilcbiAgICBdLCBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLCBcIm9uU1ZHSW5zZXJ0ZWRcIiwgdm9pZCAwKTtcbiAgICBfX2RlY29yYXRlKFtcbiAgICAgICAgY29yZV8xLk91dHB1dCgpLFxuICAgICAgICBfX21ldGFkYXRhKFwiZGVzaWduOnR5cGVcIiwgY29yZV8xLkV2ZW50RW1pdHRlcilcbiAgICBdLCBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLCBcIm9uU1ZHRmFpbGVkXCIsIHZvaWQgMCk7XG4gICAgSW5saW5lU1ZHRGlyZWN0aXZlID0gX19kZWNvcmF0ZShbXG4gICAgICAgIGNvcmVfMS5EaXJlY3RpdmUoe1xuICAgICAgICAgICAgc2VsZWN0b3I6ICdbaW5saW5lU1ZHXScsXG4gICAgICAgICAgICBwcm92aWRlcnM6IFtzdmdfY2FjaGVfc2VydmljZV8xLlNWR0NhY2hlU2VydmljZV1cbiAgICAgICAgfSksXG4gICAgICAgIF9fcGFyYW0oNiwgY29yZV8xLk9wdGlvbmFsKCkpLFxuICAgICAgICBfX3BhcmFtKDcsIGNvcmVfMS5JbmplY3QoY29yZV8xLlBMQVRGT1JNX0lEKSksXG4gICAgICAgIF9fbWV0YWRhdGEoXCJkZXNpZ246cGFyYW10eXBlc1wiLCBbY29yZV8xLkVsZW1lbnRSZWYsXG4gICAgICAgICAgICBjb3JlXzEuVmlld0NvbnRhaW5lclJlZixcbiAgICAgICAgICAgIGNvcmVfMS5Db21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgICAgICAgICBzdmdfY2FjaGVfc2VydmljZV8xLlNWR0NhY2hlU2VydmljZSxcbiAgICAgICAgICAgIGNvcmVfMS5SZW5kZXJlcjIsXG4gICAgICAgICAgICBpbmxpbmVfc3ZnX3NlcnZpY2VfMS5JbmxpbmVTVkdTZXJ2aWNlLFxuICAgICAgICAgICAgaW5saW5lX3N2Z19jb25maWdfMS5JbmxpbmVTVkdDb25maWcsXG4gICAgICAgICAgICBPYmplY3RdKVxuICAgIF0sIElubGluZVNWR0RpcmVjdGl2ZSk7XG4gICAgcmV0dXJuIElubGluZVNWR0RpcmVjdGl2ZTtcbn0oKSk7XG5leHBvcnRzLklubGluZVNWR0RpcmVjdGl2ZSA9IElubGluZVNWR0RpcmVjdGl2ZTtcbiJdfQ==